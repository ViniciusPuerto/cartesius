#!/bin/bash -e
rm -f tmp/pids/server.pid

# Wait for Postgres
if [ -n "$DATABASE_URL" ] || [ -n "$PGHOST" ]; then
  HOST=${PGHOST:-$(echo "$DATABASE_URL" | sed -n 's|^.*postgresql://[^@]*@\([^:/]*\).*|\1|p')}
  PORT=${PGPORT:-$(echo "$DATABASE_URL" | sed -n 's|^.*:\([0-9][0-9]*\)/.*|\1|p')}
  PORT=${PORT:-5432}

  echo "Waiting for Postgres at $HOST:$PORT ..."
  until pg_isready -h "$HOST" -p "$PORT" -q; do
    sleep 1
  done
  echo "Postgres is ready."
fi

# If running the server, prepare DB
if [ "${@: -2:1}" = "./bin/rails" ] && [ "${@: -1:1}" = "server" ]; then
  ./bin/rails db:prepare
fi

exec "$@"